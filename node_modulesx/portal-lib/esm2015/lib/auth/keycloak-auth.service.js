import { Injectable } from '@angular/core';
import { KeycloakService, KeycloakEventType } from 'keycloak-angular';
import { ReplaySubject } from 'rxjs';
import { ConfigurationService } from '../api/configuration.service';
import { UserProfileService } from '../api/services/user-profile.service';
import { Router } from '@angular/router';
import { CONFIG_KEY_KEYCLOAK_URL, CONFIG_KEY_KEYCLOAK_CLIENT_ID, CONFIG_KEY_KEYCLOAK_REALM, CONFIG_KEY_KEYCLOAK_ENABLE_SILENT_SSO, } from '../tkit-portal/constants';
const KC_REFRESH_TOKEN_LS = 'kc_refreshToken';
const KC_ID_TOKEN_LS = 'kc_idToken';
const KC_TOKEN_LS = 'kc_token';
const TKIT_USER_PROFILE_LS = 'tkit_user_profile';
export class KeycloakAuthService {
    constructor(keycloakService, configService, userProfileService, router) {
        this.keycloakService = keycloakService;
        this.configService = configService;
        this.userProfileService = userProfileService;
        this.router = router;
        this.user = {
            userId: 'anonymous',
            userPerson: { firstName: 'Guest' },
            functions: [],
            roles: [],
        };
    }
    hasPermission(permissionKey) {
        return this.user.functions ? this.user.functions.includes(permissionKey) : false;
    }
    currentUser() {
        return this.userProfile;
    }
    logout() {
        this.clearKCStateFromLocalstorage();
        this.keycloakService.logout();
    }
    getAuthProviderName() {
        return 'Keycloak based Security';
    }
    init() {
        console.log('Keycloak Auth initialization');
        // load previous tokens, saved after successful login of keycloak success callback
        let token = localStorage.getItem(KC_TOKEN_LS);
        let idToken = localStorage.getItem(KC_ID_TOKEN_LS);
        let refreshToken = localStorage.getItem(KC_REFRESH_TOKEN_LS);
        if (token) {
            const parsedToken = JSON.parse(atob(refreshToken.split('.')[1]));
            console.log(`Got tokens in LC ${parsedToken.exp} ${parsedToken.sub}`);
            if (parsedToken.exp * 1000 < new Date().getTime()) {
                //refresh expired, drop everything
                console.log(`Refresh token expired`);
                token = undefined;
                refreshToken = undefined;
                idToken = undefined;
                this.clearKCStateFromLocalstorage();
            }
        }
        this.setupEventListener();
        // try constructing the KC config from values in env
        let kcConfig = {
            url: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_URL),
            clientId: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_CLIENT_ID) || this.configService.getProperty('appId'),
            realm: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_REALM),
        };
        // If any of the required props is missing, fallback to loading KC conf from file
        if (!kcConfig.clientId || !kcConfig.realm || !kcConfig.url) {
            kcConfig = './assets/keycloak.json';
        }
        const enableSilentSSOCheck = this.configService.getProperty(CONFIG_KEY_KEYCLOAK_ENABLE_SILENT_SSO) === 'true';
        const kcOptions = {
            loadUserProfileAtStartUp: false,
            config: kcConfig,
            initOptions: {
                // onLoad: "login-required",
                onLoad: 'check-sso',
                checkLoginIframe: false,
                silentCheckSsoRedirectUri: enableSilentSSOCheck ? this.getSilentSSOUrl() : undefined,
                idToken,
                refreshToken,
                token,
            },
            enableBearerInterceptor: true,
            bearerExcludedUrls: ['/assets'],
        };
        // console.log(`INit KC with ${JSON.stringify(kcOptions, null, 2)}`)
        return this.keycloakService
            .init(kcOptions)
            .catch(err => {
            console.log(`kc err ${err}, try force login`);
            return this.keycloakService.login();
        })
            .then(loginOk => {
            // this will be false if our silent login did not work
            console.log(`Keycloak init done, loginOk?: ${loginOk}`);
            if (loginOk) {
                return this.keycloakService.getToken();
            }
            else {
                // we want to block bootstrap process now
                return this.keycloakService.login().then(() => 'login');
            }
        })
            .then(tokenString => {
            const parsedToken = JSON.parse(atob(tokenString.split('.')[1]));
            console.log(`fetching profile ${JSON.stringify(parsedToken)}`);
            let profileFromCache = localStorage.getItem(TKIT_USER_PROFILE_LS) &&
                JSON.parse(localStorage.getItem(TKIT_USER_PROFILE_LS));
            if (profileFromCache) {
                //if we have already a profile in LS, check if it is the smae user
                if (profileFromCache.person.email === parsedToken['email']) {
                    //same user, take from LS and load async to refresh
                    this.refreshProfile();
                    console.log(`load user profile from cache(and reloading asynchronously)`);
                    return profileFromCache;
                }
                else {
                    console.log(`User profile in LS does not match Keycloak token`);
                    localStorage.removeItem(TKIT_USER_PROFILE_LS);
                }
            }
            console.log(`load user profile from API`);
            return this.userProfileService.getCurrentUserFromBE().toPromise();
        })
            .then(userProfile => {
            // const parsedToken = JSON.parse(atob(results[1].split(".")[1]));
            console.log(`Got user profile, update state`);
            // this.updateUserFromKeycloak(results[0], parsedToken);
            this.userProfile = userProfile;
            this.avatarSubject = new ReplaySubject(1);
            this.handleAvatarUpdate(this.userProfile.avatar);
            this.userProfileService.getUpdatedAvatar().subscribe(avatar => this.handleAvatarUpdate(avatar));
            this.updateUserFromUserProfile(this.userProfile);
            localStorage.setItem(TKIT_USER_PROFILE_LS, JSON.stringify(userProfile));
            console.log(`Keycloak auth init complete`);
            return true;
        })
            .catch(err => {
            console.log(`KC ERROR ${err} as json ${JSON.stringify(err)}`);
            throw err;
        });
    }
    init2() {
        console.log('kc init 4');
        // load previous tokens, saved after successful login of keycloak success callback
        let token = localStorage.getItem(KC_TOKEN_LS);
        let idToken = localStorage.getItem(KC_ID_TOKEN_LS);
        let refreshToken = localStorage.getItem(KC_REFRESH_TOKEN_LS);
        if (token) {
            const parsedToken = JSON.parse(atob(refreshToken.split('.')[1]));
            if (parsedToken.exp * 1000 < new Date().getTime()) {
                //refresh expired, drop everything
                console.log(`Refresh token expired`);
                token = undefined;
                refreshToken = undefined;
                idToken = undefined;
                this.clearKCStateFromLocalstorage();
            }
        }
        this.setupEventListener();
        // try constructing the KC config from values in env
        let kcConfig = {
            url: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_URL),
            clientId: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_CLIENT_ID) || this.configService.getProperty('appId'),
            realm: this.configService.getProperty(CONFIG_KEY_KEYCLOAK_REALM),
        };
        // If any of the required props is missing, fallback to loading KC conf from file
        if (!kcConfig.clientId || !kcConfig.realm || !kcConfig.url) {
            kcConfig = './assets/keycloak.json';
        }
        const enableSilentSSOCheck = this.configService.getProperty(CONFIG_KEY_KEYCLOAK_ENABLE_SILENT_SSO) === 'true';
        const kcOptions = {
            loadUserProfileAtStartUp: false,
            config: kcConfig,
            initOptions: {
                // onLoad: "login-required",
                onLoad: 'check-sso',
                checkLoginIframe: false,
                silentCheckSsoRedirectUri: enableSilentSSOCheck ? this.getSilentSSOUrl() : undefined,
                idToken,
                refreshToken,
                token,
            },
            enableBearerInterceptor: true,
            bearerExcludedUrls: ['/assets'],
        };
        console.log(`INit KC with ${JSON.stringify(kcOptions, null, 2)}`);
        return (this.keycloakService
            .init(kcOptions)
            .catch(err => {
            console.log(`kc err ${err}, try force login`);
            return this.keycloakService.login();
        })
            .then(ok => {
            console.log(`After KC init ${ok}`);
            return this.keycloakService.getToken();
        })
            .then(tokenString => {
            if (tokenString) {
                const parsedToken = JSON.parse(atob(tokenString.split('.')[1]));
                console.log('fetching profile');
                let profileFromCache;
                if ((profileFromCache = localStorage.getItem(TKIT_USER_PROFILE_LS))) {
                    console.log(`load user profile from cache`);
                    //if we have already a profile in LS, check if it is the smae user
                    if (profileFromCache['email'] === parsedToken['email']) {
                        //same user, take from LS and load async to refresh
                        this.refreshProfile();
                        return JSON.parse(profileFromCache);
                    }
                    else {
                        console.log(`USer in LS does tno match. clear`);
                        localStorage.removeItem(TKIT_USER_PROFILE_LS);
                    }
                }
                console.log(`load user profile from API`);
                return this.userProfileService.getCurrentUserFromBE().toPromise();
            }
            else {
                console.log(`no TOKEN AAAAA`);
            }
        })
            // .then(ok => {
            //   // return Promise.all([
            //   //   this.keycloakService.loadUserProfile(),
            //   //   this.keycloakService.getToken(),
            //   //   this.userProfileService.getCurrentUserFromBE().toPromise()
            //   // ]);
            // })
            .catch(err => {
            console.log(`KC ERROR ${err}`);
            throw err;
        })
            .then(userProfile => {
            // const parsedToken = JSON.parse(atob(results[1].split(".")[1]));
            console.log(`Got user profile, update`);
            // this.updateUserFromKeycloak(results[0], parsedToken);
            this.userProfile = userProfile;
            this.avatarSubject = new ReplaySubject(1);
            this.handleAvatarUpdate(this.userProfile.avatar);
            this.userProfileService.getUpdatedAvatar().subscribe(avatar => this.handleAvatarUpdate(avatar));
            this.updateUserFromUserProfile(this.userProfile);
            localStorage.setItem(TKIT_USER_PROFILE_LS, JSON.stringify(userProfile));
            console.log(`KC init complete returnint`);
            return true;
        }));
    }
    setupEventListener() {
        this.keycloakService.keycloakEvents$.subscribe(ke => {
            // console.log(
            //   `KC Event ${ke.type} token: ${
            //     this.keycloakService.getKeycloakInstance().token
            //   }`
            // );
            // we are logged in, get tokens and store them in localstorage
            if (this.keycloakService.getKeycloakInstance().token) {
                localStorage.setItem(KC_TOKEN_LS, this.keycloakService.getKeycloakInstance().token);
            }
            else {
                localStorage.removeItem(KC_TOKEN_LS);
            }
            if (this.keycloakService.getKeycloakInstance().idToken) {
                localStorage.setItem(KC_ID_TOKEN_LS, this.keycloakService.getKeycloakInstance().idToken);
            }
            else {
                localStorage.removeItem(KC_ID_TOKEN_LS);
            }
            if (this.keycloakService.getKeycloakInstance().refreshToken) {
                localStorage.setItem(KC_REFRESH_TOKEN_LS, this.keycloakService.getKeycloakInstance().refreshToken);
            }
            else {
                localStorage.removeItem(KC_REFRESH_TOKEN_LS);
            }
            if (ke.type === KeycloakEventType.OnAuthLogout) {
                console.log('SSO logout nav to root');
                this.clearKCStateFromLocalstorage();
                this.router.navigateByUrl('/');
            }
        });
    }
    clearKCStateFromLocalstorage() {
        localStorage.removeItem(KC_ID_TOKEN_LS);
        localStorage.removeItem(KC_TOKEN_LS);
        localStorage.removeItem(KC_REFRESH_TOKEN_LS);
    }
    getSilentSSOUrl() {
        let currentBase = document.getElementsByTagName('base')[0].href;
        if (currentBase === '/') {
            currentBase = '';
        }
        return `${currentBase}/assets/silent-check-sso.html`;
    }
    hasRole(role) {
        if (typeof role === 'string') {
            const roleString = role;
            return this.user.roles.map(e => e.toUpperCase()).includes(roleString.toUpperCase());
        }
        else {
            return (this.user.roles
                .map(e => e.toUpperCase())
                .filter(item => role.map(e => e.toUpperCase()).includes(item.toUpperCase())).length > 0);
        }
    }
    getRoles() {
        return this.user.roles;
    }
    refreshProfile() {
        this.userProfileService.getCurrentUserFromBE().subscribe(profileData => {
            this.userProfile = profileData;
            localStorage.setItem(TKIT_USER_PROFILE_LS, JSON.stringify(profileData));
            this.updateUserFromUserProfile(this.userProfile);
        });
    }
    loadFullProfile() {
        return this.userProfileService.getCurrentUser();
    }
    handleAvatarUpdate(avatarInfo) {
        if ((avatarInfo === null || avatarInfo === void 0 ? void 0 : avatarInfo.avatarImageUrl) && (avatarInfo === null || avatarInfo === void 0 ? void 0 : avatarInfo.avatarSmallImageUrl)) {
            this.avatarSubject.next({
                avatarImageUrl: 'portal-api' + avatarInfo.avatarImageUrl,
                avatarSmallImageUrl: 'portal-api' + avatarInfo.avatarSmallImageUrl
            });
        }
        else {
            this.avatarSubject.next(null);
        }
    }
    getAvatar() {
        return this.avatarSubject.asObservable();
    }
    updateUserFromUserProfile(userProfile) {
        this.user = {
            roles: userProfile.roles,
            userId: userProfile.id,
            principalId: userProfile.id,
            commonName: userProfile.person.displayName,
            userPerson: Object.assign({}, userProfile.person),
            functions: [],
        };
        if (this.userProfile.memberships) {
            this.userProfile.memberships.forEach(m => {
                m.roleMemberships.forEach(r => {
                    r.permissions.forEach(p => {
                        this.user.functions.push(p.key);
                    });
                });
            });
        }
    }
}
KeycloakAuthService.decorators = [
    { type: Injectable }
];
KeycloakAuthService.ctorParameters = () => [
    { type: KeycloakService },
    { type: ConfigurationService },
    { type: UserProfileService },
    { type: Router }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Y2xvYWstYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcG9ydGFsLWxpYi9zcmMvbGliL2F1dGgva2V5Y2xvYWstYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVUsTUFBTSxlQUFlLENBQUE7QUFDbEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxpQkFBaUIsRUFBbUIsTUFBTSxrQkFBa0IsQ0FBQTtBQUN0RixPQUFPLEVBQWtCLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQTtBQUNwRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUtuRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQTtBQUN6RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUE7QUFDeEMsT0FBTyxFQUNMLHVCQUF1QixFQUN2Qiw2QkFBNkIsRUFDN0IseUJBQXlCLEVBQ3pCLHFDQUFxQyxHQUN0QyxNQUFNLDBCQUEwQixDQUFBO0FBR2pDLE1BQU0sbUJBQW1CLEdBQUcsaUJBQWlCLENBQUE7QUFDN0MsTUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFBO0FBQ25DLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQTtBQUM5QixNQUFNLG9CQUFvQixHQUFHLG1CQUFtQixDQUFBO0FBR2hELE1BQU0sT0FBTyxtQkFBbUI7SUFVOUIsWUFDVSxlQUFnQyxFQUNoQyxhQUFtQyxFQUNuQyxrQkFBc0MsRUFDdEMsTUFBYztRQUhkLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxrQkFBYSxHQUFiLGFBQWEsQ0FBc0I7UUFDbkMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBWGhCLFNBQUksR0FBUztZQUNuQixNQUFNLEVBQUUsV0FBVztZQUNuQixVQUFVLEVB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QUNKLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDOzs7WUExV0YsVUFBVTs7O1lBdEJGLGVBQWU7WUFFZixvQkFBb0I7WUFLcEIsa0JBQWtCO1lBQ2xCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xuaW1wb3J0IHsgS2V5Y2xvYWtTZXJ2aWNlLCBLZXljbG9ha0V2ZW50VHlwZSwgS2V5Y2xvYWtPcHRpb25zIH0gZnJvbSAna2V5Y2xvYWstYW5ndWxhcidcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcydcbmltcG9ydCB7IENvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vYXBpL2NvbmZpZ3VyYXRpb24uc2VydmljZSdcbmltcG9ydCB7IElBdXRoU2VydmljZSB9IGZyb20gJy4uL2FwaS9pYXV0aC5zZXJ2aWNlJ1xuaW1wb3J0IHsgVXNlciB9IGZyb20gJy4uL2FwaS9tb2RlbCdcbmltcG9ydCB7IEF2YXRhckluZm8gfSBmcm9tICcuLi9hcGkvbW9kZWwvYXZhdGFyLWluZm8ubW9kZWwnXG5pbXBvcnQgeyBVc2VyUHJvZmlsZSB9IGZyb20gJy4uL2FwaS9tb2RlbC91c2VyLXByb2ZpbGUubW9kZWwnXG5pbXBvcnQgeyBVc2VyUHJvZmlsZVNlcnZpY2UgfSBmcm9tICcuLi9hcGkvc2VydmljZXMvdXNlci1wcm9maWxlLnNlcnZpY2UnXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInXG5pbXBvcnQge1xuICBDT05GSUdfS0VZX0tFWUNMT0FLX1VSTCxcbiAgQ09ORklHX0tFWV9LRVlDTE9BS19DTElFTlRfSUQsXG4gIENPTkZJR19LRVlfS0VZQ0xPQUtfUkVBTE0sXG4gIENPTkZJR19LRVlfS0VZQ0xPQUtfRU5BQkxFX1NJTEVOVF9TU08sXG59IGZyb20gJy4uL3RraXQtcG9ydGFsL2NvbnN0YW50cydcbmltcG9ydCB7IEtleWNsb2FrQ29uZmlnIH0gZnJvbSAna2V5Y2xvYWstanMnXG5cbmNvbnN0IEtDX1JFRlJFU0hfVE9LRU5fTFMgPSAna2NfcmVmcmVzaFRva2VuJ1xuY29uc3QgS0NfSURfVE9LRU5fTFMgPSAna2NfaWRUb2tlbidcbmNvbnN0IEtDX1RPS0VOX0xTID0gJ2tjX3Rva2VuJ1xuY29uc3QgVEtJVF9VU0VSX1BST0ZJTEVfTFMgPSAndGtpdF91c2VyX3Byb2ZpbGUnXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBLZXljbG9ha0F1dGhTZXJ2aWNlIGltcGxlbWVudHMgSUF1dGhTZXJ2aWNlIHtcbiAgdXNlclByb2ZpbGU6IFVzZXJQcm9maWxlXG4gIGF2YXRhclN1YmplY3Q6IFJlcGxheVN1YmplY3Q8QXZhdGFySW5mbz5cbiAgcHJpdmF0ZSB1c2VyOiBVc2VyID0ge1xuICAgIHVzZXJJZDogJ2Fub255bW91cycsXG4gICAgdXNlclBlcnNvbjogeyBmaXJzdE5hbWU6ICdHdWVzdCcgfSxcbiAgICBmdW5jdGlvbnM6IFtdLFxuICAgIHJvbGVzOiBbXSxcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUga2V5Y2xvYWtTZXJ2aWNlOiBLZXljbG9ha1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb25maWdTZXJ2aWNlOiBDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHVzZXJQcm9maWxlU2VydmljZTogVXNlclByb2ZpbGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXJcbiAgKSB7fVxuXG4gIGhhc1Blcm1pc3Npb24ocGVybWlzc2lvbktleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudXNlci5mdW5jdGlvbnMgPyB0aGlzLnVzZXIuZnVuY3Rpb25zLmluY2x1ZGVzKHBlcm1pc3Npb25LZXkpIDogZmFsc2VcbiAgfVxuICBjdXJyZW50VXNlcigpOiBVc2VyUHJvZmlsZSB7XG4gICAgcmV0dXJuIHRoaXMudXNlclByb2ZpbGVcbiAgfVxuICBsb2dvdXQoKSB7XG4gICAgdGhpcy5jbGVhcktDU3RhdGVGcm9tTG9jYWxzdG9yYWdlKClcbiAgICB0aGlzLmtleWNsb2FrU2VydmljZS5sb2dvdXQoKVxuICB9XG4gIGdldEF1dGhQcm92aWRlck5hbWUoKSB7XG4gICAgcmV0dXJuICdLZXljbG9hayBiYXNlZCBTZWN1cml0eSdcbiAgfVxuXG4gIHB1YmxpYyBpbml0KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnNvbGUubG9nKCdLZXljbG9hayBBdXRoIGluaXRpYWxpemF0aW9uJylcbiAgICAvLyBsb2FkIHByZXZpb3VzIHRva2Vucywgc2F2ZWQgYWZ0ZXIgc3VjY2Vzc2Z1bCBsb2dpbiBvZiBrZXljbG9hayBzdWNjZXNzIGNhbGxiYWNrXG4gICAgbGV0IHRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0NfVE9LRU5fTFMpXG4gICAgbGV0IGlkVG9rZW4gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLQ19JRF9UT0tFTl9MUylcbiAgICBsZXQgcmVmcmVzaFRva2VuID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oS0NfUkVGUkVTSF9UT0tFTl9MUylcbiAgICBpZiAodG9rZW4pIHtcbiAgICAgIGNvbnN0IHBhcnNlZFRva2VuID0gSlNPTi5wYXJzZShhdG9iKHJlZnJlc2hUb2tlbi5zcGxpdCgnLicpWzFdKSlcbiAgICAgIGNvbnNvbGUubG9nKGBHb3QgdG9rZW5zIGluIExDICR7cGFyc2VkVG9rZW4uZXhwfSAke3BhcnNlZFRva2VuLnN1Yn1gKVxuICAgICAgaWYgKHBhcnNlZFRva2VuLmV4cCAqIDEwMDAgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKSkge1xuICAgICAgICAvL3JlZnJlc2ggZXhwaXJlZCwgZHJvcCBldmVyeXRoaW5nXG4gICAgICAgIGNvbnNvbGUubG9nKGBSZWZyZXNoIHRva2VuIGV4cGlyZWRgKVxuICAgICAgICB0b2tlbiA9IHVuZGVmaW5lZFxuICAgICAgICByZWZyZXNoVG9rZW4gPSB1bmRlZmluZWRcbiAgICAgICAgaWRUb2tlbiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLmNsZWFyS0NTdGF0ZUZyb21Mb2NhbHN0b3JhZ2UoKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2V0dXBFdmVudExpc3RlbmVyKClcblxuICAgIC8vIHRyeSBjb25zdHJ1Y3RpbmcgdGhlIEtDIGNvbmZpZyBmcm9tIHZhbHVlcyBpbiBlbnZcbiAgICBsZXQga2NDb25maWc6IEtleWNsb2FrQ29uZmlnIHwgc3RyaW5nID0ge1xuICAgICAgdXJsOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0UHJvcGVydHkoQ09ORklHX0tFWV9LRVlDTE9BS19VUkwpLFxuICAgICAgY2xpZW50SWQ6XG4gICAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX0NMSUVOVF9JRCkgfHwgdGhpcy5jb25maWdTZXJ2aWNlLmdldFByb3BlcnR5KCdhcHBJZCcpLFxuICAgICAgcmVhbG06IHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX1JFQUxNKSxcbiAgICB9XG4gICAgLy8gSWYgYW55IG9mIHRoZSByZXF1aXJlZCBwcm9wcyBpcyBtaXNzaW5nLCBmYWxsYmFjayB0byBsb2FkaW5nIEtDIGNvbmYgZnJvbSBmaWxlXG4gICAgaWYgKCFrY0NvbmZpZy5jbGllbnRJZCB8fCAha2NDb25maWcucmVhbG0gfHwgIWtjQ29uZmlnLnVybCkge1xuICAgICAga2NDb25maWcgPSAnLi9hc3NldHMva2V5Y2xvYWsuanNvbidcbiAgICB9XG5cbiAgICBjb25zdCBlbmFibGVTaWxlbnRTU09DaGVjayA9IHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX0VOQUJMRV9TSUxFTlRfU1NPKSA9PT0gJ3RydWUnXG5cbiAgICBjb25zdCBrY09wdGlvbnM6IEtleWNsb2FrT3B0aW9ucyA9IHtcbiAgICAgIGxvYWRVc2VyUHJvZmlsZUF0U3RhcnRVcDogZmFsc2UsXG4gICAgICBjb25maWc6IGtjQ29uZmlnLFxuICAgICAgaW5pdE9wdGlvbnM6IHtcbiAgICAgICAgLy8gb25Mb2FkOiBcImxvZ2luLXJlcXVpcmVkXCIsXG4gICAgICAgIG9uTG9hZDogJ2NoZWNrLXNzbycsXG4gICAgICAgIGNoZWNrTG9naW5JZnJhbWU6IGZhbHNlLFxuICAgICAgICBzaWxlbnRDaGVja1Nzb1JlZGlyZWN0VXJpOiBlbmFibGVTaWxlbnRTU09DaGVjayA/IHRoaXMuZ2V0U2lsZW50U1NPVXJsKCkgOiB1bmRlZmluZWQsXG4gICAgICAgIGlkVG9rZW4sXG4gICAgICAgIHJlZnJlc2hUb2tlbixcbiAgICAgICAgdG9rZW4sXG4gICAgICB9LFxuICAgICAgZW5hYmxlQmVhcmVySW50ZXJjZXB0b3I6IHRydWUsXG4gICAgICBiZWFyZXJFeGNsdWRlZFVybHM6IFsnL2Fzc2V0cyddLFxuICAgIH1cblxuICAgIC8vIGNvbnNvbGUubG9nKGBJTml0IEtDIHdpdGggJHtKU09OLnN0cmluZ2lmeShrY09wdGlvbnMsIG51bGwsIDIpfWApXG4gICAgcmV0dXJuIHRoaXMua2V5Y2xvYWtTZXJ2aWNlXG4gICAgICAuaW5pdChrY09wdGlvbnMpXG4gICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coYGtjIGVyciAke2Vycn0sIHRyeSBmb3JjZSBsb2dpbmApXG4gICAgICAgIHJldHVybiB0aGlzLmtleWNsb2FrU2VydmljZS5sb2dpbigpXG4gICAgICB9KVxuICAgICAgLnRoZW4obG9naW5PayA9PiB7XG4gICAgICAgIC8vIHRoaXMgd2lsbCBiZSBmYWxzZSBpZiBvdXIgc2lsZW50IGxvZ2luIGRpZCBub3Qgd29ya1xuICAgICAgICBjb25zb2xlLmxvZyhgS2V5Y2xvYWsgaW5pdCBkb25lLCBsb2dpbk9rPzogJHtsb2dpbk9rfWApXG4gICAgICAgIGlmIChsb2dpbk9rKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMua2V5Y2xvYWtTZXJ2aWNlLmdldFRva2VuKClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB3ZSB3YW50IHRvIGJsb2NrIGJvb3RzdHJhcCBwcm9jZXNzIG5vd1xuICAgICAgICAgIHJldHVybiB0aGlzLmtleWNsb2FrU2VydmljZS5sb2dpbigpLnRoZW4oKCkgPT4gJ2xvZ2luJylcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKHRva2VuU3RyaW5nID0+IHtcbiAgICAgICAgY29uc3QgcGFyc2VkVG9rZW4gPSBKU09OLnBhcnNlKGF0b2IodG9rZW5TdHJpbmcuc3BsaXQoJy4nKVsxXSkpXG4gICAgICAgIGNvbnNvbGUubG9nKGBmZXRjaGluZyBwcm9maWxlICR7SlNPTi5zdHJpbmdpZnkocGFyc2VkVG9rZW4pfWApXG4gICAgICAgIGxldCBwcm9maWxlRnJvbUNhY2hlID1cbiAgICAgICAgICBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShUS0lUX1VTRVJfUFJPRklMRV9MUykgJiZcbiAgICAgICAgICAoSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShUS0lUX1VTRVJfUFJPRklMRV9MUykpIGFzIFVzZXJQcm9maWxlKVxuICAgICAgICBpZiAocHJvZmlsZUZyb21DYWNoZSkge1xuICAgICAgICAgIC8vaWYgd2UgaGF2ZSBhbHJlYWR5IGEgcHJvZmlsZSBpbiBMUywgY2hlY2sgaWYgaXQgaXMgdGhlIHNtYWUgdXNlclxuICAgICAgICAgIGlmIChwcm9maWxlRnJvbUNhY2hlLnBlcnNvbi5lbWFpbCA9PT0gcGFyc2VkVG9rZW5bJ2VtYWlsJ10pIHtcbiAgICAgICAgICAgIC8vc2FtZSB1c2VyLCB0YWtlIGZyb20gTFMgYW5kIGxvYWQgYXN5bmMgdG8gcmVmcmVzaFxuICAgICAgICAgICAgdGhpcy5yZWZyZXNoUHJvZmlsZSgpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9hZCB1c2VyIHByb2ZpbGUgZnJvbSBjYWNoZShhbmQgcmVsb2FkaW5nIGFzeW5jaHJvbm91c2x5KWApXG4gICAgICAgICAgICByZXR1cm4gcHJvZmlsZUZyb21DYWNoZVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgVXNlciBwcm9maWxlIGluIExTIGRvZXMgbm90IG1hdGNoIEtleWNsb2FrIHRva2VuYClcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFRLSVRfVVNFUl9QUk9GSUxFX0xTKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhgbG9hZCB1c2VyIHByb2ZpbGUgZnJvbSBBUElgKVxuICAgICAgICByZXR1cm4gdGhpcy51c2VyUHJvZmlsZVNlcnZpY2UuZ2V0Q3VycmVudFVzZXJGcm9tQkUoKS50b1Byb21pc2UoKVxuICAgICAgfSlcbiAgICAgIC50aGVuKHVzZXJQcm9maWxlID0+IHtcbiAgICAgICAgLy8gY29uc3QgcGFyc2VkVG9rZW4gPSBKU09OLnBhcnNlKGF0b2IocmVzdWx0c1sxXS5zcGxpdChcIi5cIilbMV0pKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhgR290IHVzZXIgcHJvZmlsZSwgdXBkYXRlIHN0YXRlYClcbiAgICAgICAgLy8gdGhpcy51cGRhdGVVc2VyRnJvbUtleWNsb2FrKHJlc3VsdHNbMF0sIHBhcnNlZFRva2VuKTtcbiAgICAgICAgdGhpcy51c2VyUHJvZmlsZSA9IHVzZXJQcm9maWxlXG4gICAgICAgIHRoaXMuYXZhdGFyU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PEF2YXRhckluZm8+KDEpXG4gICAgICAgIHRoaXMuaGFuZGxlQXZhdGFyVXBkYXRlKHRoaXMudXNlclByb2ZpbGUuYXZhdGFyKVxuICAgICAgICB0aGlzLnVzZXJQcm9maWxlU2VydmljZS5nZXRVcGRhdGVkQXZhdGFyKCkuc3Vic2NyaWJlKGF2YXRhciA9PiB0aGlzLmhhbmRsZUF2YXRhclVwZGF0ZShhdmF0YXIpKVxuICAgICAgICB0aGlzLnVwZGF0ZVVzZXJGcm9tVXNlclByb2ZpbGUodGhpcy51c2VyUHJvZmlsZSlcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oVEtJVF9VU0VSX1BST0ZJTEVfTFMsIEpTT04uc3RyaW5naWZ5KHVzZXJQcm9maWxlKSlcbiAgICAgICAgY29uc29sZS5sb2coYEtleWNsb2FrIGF1dGggaW5pdCBjb21wbGV0ZWApXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBLQyBFUlJPUiAke2Vycn0gYXMganNvbiAke0pTT04uc3RyaW5naWZ5KGVycil9YClcbiAgICAgICAgdGhyb3cgZXJyXG4gICAgICB9KVxuICB9XG5cbiAgcHVibGljIGluaXQyKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnNvbGUubG9nKCdrYyBpbml0IDQnKVxuICAgIC8vIGxvYWQgcHJldmlvdXMgdG9rZW5zLCBzYXZlZCBhZnRlciBzdWNjZXNzZnVsIGxvZ2luIG9mIGtleWNsb2FrIHN1Y2Nlc3MgY2FsbGJhY2tcbiAgICBsZXQgdG9rZW4gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLQ19UT0tFTl9MUylcbiAgICBsZXQgaWRUb2tlbiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKEtDX0lEX1RPS0VOX0xTKVxuICAgIGxldCByZWZyZXNoVG9rZW4gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShLQ19SRUZSRVNIX1RPS0VOX0xTKVxuICAgIGlmICh0b2tlbikge1xuICAgICAgY29uc3QgcGFyc2VkVG9rZW4gPSBKU09OLnBhcnNlKGF0b2IocmVmcmVzaFRva2VuLnNwbGl0KCcuJylbMV0pKVxuICAgICAgaWYgKHBhcnNlZFRva2VuLmV4cCAqIDEwMDAgPCBuZXcgRGF0ZSgpLmdldFRpbWUoKSkge1xuICAgICAgICAvL3JlZnJlc2ggZXhwaXJlZCwgZHJvcCBldmVyeXRoaW5nXG4gICAgICAgIGNvbnNvbGUubG9nKGBSZWZyZXNoIHRva2VuIGV4cGlyZWRgKVxuICAgICAgICB0b2tlbiA9IHVuZGVmaW5lZFxuICAgICAgICByZWZyZXNoVG9rZW4gPSB1bmRlZmluZWRcbiAgICAgICAgaWRUb2tlbiA9IHVuZGVmaW5lZFxuICAgICAgICB0aGlzLmNsZWFyS0NTdGF0ZUZyb21Mb2NhbHN0b3JhZ2UoKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2V0dXBFdmVudExpc3RlbmVyKClcblxuICAgIC8vIHRyeSBjb25zdHJ1Y3RpbmcgdGhlIEtDIGNvbmZpZyBmcm9tIHZhbHVlcyBpbiBlbnZcbiAgICBsZXQga2NDb25maWc6IEtleWNsb2FrQ29uZmlnIHwgc3RyaW5nID0ge1xuICAgICAgdXJsOiB0aGlzLmNvbmZpZ1NlcnZpY2UuZ2V0UHJvcGVydHkoQ09ORklHX0tFWV9LRVlDTE9BS19VUkwpLFxuICAgICAgY2xpZW50SWQ6XG4gICAgICAgIHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX0NMSUVOVF9JRCkgfHwgdGhpcy5jb25maWdTZXJ2aWNlLmdldFByb3BlcnR5KCdhcHBJZCcpLFxuICAgICAgcmVhbG06IHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX1JFQUxNKSxcbiAgICB9XG4gICAgLy8gSWYgYW55IG9mIHRoZSByZXF1aXJlZCBwcm9wcyBpcyBtaXNzaW5nLCBmYWxsYmFjayB0byBsb2FkaW5nIEtDIGNvbmYgZnJvbSBmaWxlXG4gICAgaWYgKCFrY0NvbmZpZy5jbGllbnRJZCB8fCAha2NDb25maWcucmVhbG0gfHwgIWtjQ29uZmlnLnVybCkge1xuICAgICAga2NDb25maWcgPSAnLi9hc3NldHMva2V5Y2xvYWsuanNvbidcbiAgICB9XG5cbiAgICBjb25zdCBlbmFibGVTaWxlbnRTU09DaGVjayA9IHRoaXMuY29uZmlnU2VydmljZS5nZXRQcm9wZXJ0eShDT05GSUdfS0VZX0tFWUNMT0FLX0VOQUJMRV9TSUxFTlRfU1NPKSA9PT0gJ3RydWUnXG5cbiAgICBjb25zdCBrY09wdGlvbnM6IEtleWNsb2FrT3B0aW9ucyA9IHtcbiAgICAgIGxvYWRVc2VyUHJvZmlsZUF0U3RhcnRVcDogZmFsc2UsXG4gICAgICBjb25maWc6IGtjQ29uZmlnLFxuICAgICAgaW5pdE9wdGlvbnM6IHtcbiAgICAgICAgLy8gb25Mb2FkOiBcImxvZ2luLXJlcXVpcmVkXCIsXG4gICAgICAgIG9uTG9hZDogJ2NoZWNrLXNzbycsXG4gICAgICAgIGNoZWNrTG9naW5JZnJhbWU6IGZhbHNlLFxuICAgICAgICBzaWxlbnRDaGVja1Nzb1JlZGlyZWN0VXJpOiBlbmFibGVTaWxlbnRTU09DaGVjayA/IHRoaXMuZ2V0U2lsZW50U1NPVXJsKCkgOiB1bmRlZmluZWQsXG4gICAgICAgIGlkVG9rZW4sXG4gICAgICAgIHJlZnJlc2hUb2tlbixcbiAgICAgICAgdG9rZW4sXG4gICAgICB9LFxuICAgICAgZW5hYmxlQmVhcmVySW50ZXJjZXB0b3I6IHRydWUsXG4gICAgICBiZWFyZXJFeGNsdWRlZFVybHM6IFsnL2Fzc2V0cyddLFxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBJTml0IEtDIHdpdGggJHtKU09OLnN0cmluZ2lmeShrY09wdGlvbnMsIG51bGwsIDIpfWApXG5cbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5rZXljbG9ha1NlcnZpY2VcbiAgICAgICAgLmluaXQoa2NPcHRpb25zKVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhga2MgZXJyICR7ZXJyfSwgdHJ5IGZvcmNlIGxvZ2luYClcbiAgICAgICAgICByZXR1cm4gdGhpcy5rZXljbG9ha1NlcnZpY2UubG9naW4oKVxuICAgICAgICB9KVxuICAgICAgICAudGhlbihvayA9PiB7XG4gICAgICAgICAgY29uc29sZS5sb2coYEFmdGVyIEtDIGluaXQgJHtva31gKVxuICAgICAgICAgIHJldHVybiB0aGlzLmtleWNsb2FrU2VydmljZS5nZXRUb2tlbigpXG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKHRva2VuU3RyaW5nID0+IHtcbiAgICAgICAgICBpZiAodG9rZW5TdHJpbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFRva2VuID0gSlNPTi5wYXJzZShhdG9iKHRva2VuU3RyaW5nLnNwbGl0KCcuJylbMV0pKVxuICAgICAgICAgICAgY29uc29sZS5sb2coJ2ZldGNoaW5nIHByb2ZpbGUnKVxuICAgICAgICAgICAgbGV0IHByb2ZpbGVGcm9tQ2FjaGVcbiAgICAgICAgICAgIGlmICgocHJvZmlsZUZyb21DYWNoZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFRLSVRfVVNFUl9QUk9GSUxFX0xTKSkpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYGxvYWQgdXNlciBwcm9maWxlIGZyb20gY2FjaGVgKVxuICAgICAgICAgICAgICAvL2lmIHdlIGhhdmUgYWxyZWFkeSBhIHByb2ZpbGUgaW4gTFMsIGNoZWNrIGlmIGl0IGlzIHRoZSBzbWFlIHVzZXJcbiAgICAgICAgICAgICAgaWYgKHByb2ZpbGVGcm9tQ2FjaGVbJ2VtYWlsJ10gPT09IHBhcnNlZFRva2VuWydlbWFpbCddKSB7XG4gICAgICAgICAgICAgICAgLy9zYW1lIHVzZXIsIHRha2UgZnJvbSBMUyBhbmQgbG9hZCBhc3luYyB0byByZWZyZXNoXG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoUHJvZmlsZSgpXG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UocHJvZmlsZUZyb21DYWNoZSkgYXMgVXNlclByb2ZpbGVcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgVVNlciBpbiBMUyBkb2VzIHRubyBtYXRjaC4gY2xlYXJgKVxuICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKFRLSVRfVVNFUl9QUk9GSUxFX0xTKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9hZCB1c2VyIHByb2ZpbGUgZnJvbSBBUElgKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudXNlclByb2ZpbGVTZXJ2aWNlLmdldEN1cnJlbnRVc2VyRnJvbUJFKCkudG9Qcm9taXNlKClcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYG5vIFRPS0VOIEFBQUFBYClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC8vIC50aGVuKG9rID0+IHtcbiAgICAgICAgLy8gICAvLyByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAvLyAgIC8vICAgdGhpcy5rZXljbG9ha1NlcnZpY2UubG9hZFVzZXJQcm9maWxlKCksXG4gICAgICAgIC8vICAgLy8gICB0aGlzLmtleWNsb2FrU2VydmljZS5nZXRUb2tlbigpLFxuICAgICAgICAvLyAgIC8vICAgdGhpcy51c2VyUHJvZmlsZVNlcnZpY2UuZ2V0Q3VycmVudFVzZXJGcm9tQkUoKS50b1Byb21pc2UoKVxuICAgICAgICAvLyAgIC8vIF0pO1xuICAgICAgICAvLyB9KVxuICAgICAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgS0MgRVJST1IgJHtlcnJ9YClcbiAgICAgICAgICB0aHJvdyBlcnJcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4odXNlclByb2ZpbGUgPT4ge1xuICAgICAgICAgIC8vIGNvbnN0IHBhcnNlZFRva2VuID0gSlNPTi5wYXJzZShhdG9iKHJlc3VsdHNbMV0uc3BsaXQoXCIuXCIpWzFdKSk7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZyhgR290IHVzZXIgcHJvZmlsZSwgdXBkYXRlYClcbiAgICAgICAgICAvLyB0aGlzLnVwZGF0ZVVzZXJGcm9tS2V5Y2xvYWsocmVzdWx0c1swXSwgcGFyc2VkVG9rZW4pO1xuICAgICAgICAgIHRoaXMudXNlclByb2ZpbGUgPSB1c2VyUHJvZmlsZVxuICAgICAgICAgIHRoaXMuYXZhdGFyU3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PEF2YXRhckluZm8+KDEpXG4gICAgICAgICAgdGhpcy5oYW5kbGVBdmF0YXJVcGRhdGUodGhpcy51c2VyUHJvZmlsZS5hdmF0YXIpXG4gICAgICAgICAgdGhpcy51c2VyUHJvZmlsZVNlcnZpY2UuZ2V0VXBkYXRlZEF2YXRhcigpLnN1YnNjcmliZShhdmF0YXIgPT4gdGhpcy5oYW5kbGVBdmF0YXJVcGRhdGUoYXZhdGFyKSlcbiAgICAgICAgICB0aGlzLnVwZGF0ZVVzZXJGcm9tVXNlclByb2ZpbGUodGhpcy51c2VyUHJvZmlsZSlcbiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShUS0lUX1VTRVJfUFJPRklMRV9MUywgSlNPTi5zdHJpbmdpZnkodXNlclByb2ZpbGUpKVxuICAgICAgICAgIGNvbnNvbGUubG9nKGBLQyBpbml0IGNvbXBsZXRlIHJldHVybmludGApXG4gICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgfSlcbiAgICApXG4gIH1cblxuICBwcml2YXRlIHNldHVwRXZlbnRMaXN0ZW5lcigpIHtcbiAgICB0aGlzLmtleWNsb2FrU2VydmljZS5rZXljbG9ha0V2ZW50cyQuc3Vic2NyaWJlKGtlID0+IHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKFxuICAgICAgLy8gICBgS0MgRXZlbnQgJHtrZS50eXBlfSB0b2tlbjogJHtcbiAgICAgIC8vICAgICB0aGlzLmtleWNsb2FrU2VydmljZS5nZXRLZXljbG9ha0luc3RhbmNlKCkudG9rZW5cbiAgICAgIC8vICAgfWBcbiAgICAgIC8vICk7XG4gICAgICAvLyB3ZSBhcmUgbG9nZ2VkIGluLCBnZXQgdG9rZW5zIGFuZCBzdG9yZSB0aGVtIGluIGxvY2Fsc3RvcmFnZVxuICAgICAgaWYgKHRoaXMua2V5Y2xvYWtTZXJ2aWNlLmdldEtleWNsb2FrSW5zdGFuY2UoKS50b2tlbikge1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLQ19UT0tFTl9MUywgdGhpcy5rZXljbG9ha1NlcnZpY2UuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnRva2VuKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0NfVE9LRU5fTFMpXG4gICAgICB9XG4gICAgICBpZiAodGhpcy5rZXljbG9ha1NlcnZpY2UuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLmlkVG9rZW4pIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oS0NfSURfVE9LRU5fTFMsIHRoaXMua2V5Y2xvYWtTZXJ2aWNlLmdldEtleWNsb2FrSW5zdGFuY2UoKS5pZFRva2VuKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0NfSURfVE9LRU5fTFMpXG4gICAgICB9XG4gICAgICBpZiAodGhpcy5rZXljbG9ha1NlcnZpY2UuZ2V0S2V5Y2xvYWtJbnN0YW5jZSgpLnJlZnJlc2hUb2tlbikge1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShLQ19SRUZSRVNIX1RPS0VOX0xTLCB0aGlzLmtleWNsb2FrU2VydmljZS5nZXRLZXljbG9ha0luc3RhbmNlKCkucmVmcmVzaFRva2VuKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oS0NfUkVGUkVTSF9UT0tFTl9MUylcbiAgICAgIH1cbiAgICAgIGlmIChrZS50eXBlID09PSBLZXljbG9ha0V2ZW50VHlwZS5PbkF1dGhMb2dvdXQpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1NTTyBsb2dvdXQgbmF2IHRvIHJvb3QnKVxuICAgICAgICB0aGlzLmNsZWFyS0NTdGF0ZUZyb21Mb2NhbHN0b3JhZ2UoKVxuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKCcvJylcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBjbGVhcktDU3RhdGVGcm9tTG9jYWxzdG9yYWdlKCkge1xuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtDX0lEX1RPS0VOX0xTKVxuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtDX1RPS0VOX0xTKVxuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKEtDX1JFRlJFU0hfVE9LRU5fTFMpXG4gIH1cblxuICBwcml2YXRlIGdldFNpbGVudFNTT1VybCgpIHtcbiAgICBsZXQgY3VycmVudEJhc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYmFzZScpWzBdLmhyZWZcbiAgICBpZiAoY3VycmVudEJhc2UgPT09ICcvJykge1xuICAgICAgY3VycmVudEJhc2UgPSAnJ1xuICAgIH1cbiAgICByZXR1cm4gYCR7Y3VycmVudEJhc2V9L2Fzc2V0cy9zaWxlbnQtY2hlY2stc3NvLmh0bWxgXG4gIH1cblxuICBoYXNSb2xlKHJvbGU6IHN0cmluZyB8IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgaWYgKHR5cGVvZiByb2xlID09PSAnc3RyaW5nJykge1xuICAgICAgY29uc3Qgcm9sZVN0cmluZyA9IHJvbGUgYXMgc3RyaW5nXG4gICAgICByZXR1cm4gdGhpcy51c2VyLnJvbGVzLm1hcChlID0+IGUudG9VcHBlckNhc2UoKSkuaW5jbHVkZXMocm9sZVN0cmluZy50b1VwcGVyQ2FzZSgpKVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICB0aGlzLnVzZXIucm9sZXNcbiAgICAgICAgICAubWFwKGUgPT4gZS50b1VwcGVyQ2FzZSgpKVxuICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiByb2xlLm1hcChlID0+IGUudG9VcHBlckNhc2UoKSkuaW5jbHVkZXMoaXRlbS50b1VwcGVyQ2FzZSgpKSkubGVuZ3RoID4gMFxuICAgICAgKVxuICAgIH1cbiAgfVxuXG4gIGdldFJvbGVzKCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gdGhpcy51c2VyLnJvbGVzXG4gIH1cblxuICByZWZyZXNoUHJvZmlsZSgpIHtcbiAgICB0aGlzLnVzZXJQcm9maWxlU2VydmljZS5nZXRDdXJyZW50VXNlckZyb21CRSgpLnN1YnNjcmliZShwcm9maWxlRGF0YSA9PiB7XG4gICAgICB0aGlzLnVzZXJQcm9maWxlID0gcHJvZmlsZURhdGFcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFRLSVRfVVNFUl9QUk9GSUxFX0xTLCBKU09OLnN0cmluZ2lmeShwcm9maWxlRGF0YSkpXG4gICAgICB0aGlzLnVwZGF0ZVVzZXJGcm9tVXNlclByb2ZpbGUodGhpcy51c2VyUHJvZmlsZSlcbiAgICB9KVxuICB9XG5cbiAgbG9hZEZ1bGxQcm9maWxlKCk6IE9ic2VydmFibGU8VXNlclByb2ZpbGU+IHtcbiAgICByZXR1cm4gdGhpcy51c2VyUHJvZmlsZVNlcnZpY2UuZ2V0Q3VycmVudFVzZXIoKVxuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVBdmF0YXJVcGRhdGUoYXZhdGFySW5mbzogQXZhdGFySW5mbykge1xuICAgIGlmIChhdmF0YXJJbmZvPy5hdmF0YXJJbWFnZVVybCAmJiBhdmF0YXJJbmZvPy5hdmF0YXJTbWFsbEltYWdlVXJsKSB7XG4gICAgICB0aGlzLmF2YXRhclN1YmplY3QubmV4dCh7XG4gICAgICAgIGF2YXRhckltYWdlVXJsOiAncG9ydGFsLWFwaScgKyBhdmF0YXJJbmZvLmF2YXRhckltYWdlVXJsLFxuICAgICAgICBhdmF0YXJTbWFsbEltYWdlVXJsOiAncG9ydGFsLWFwaScgKyBhdmF0YXJJbmZvLmF2YXRhclNtYWxsSW1hZ2VVcmxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmF2YXRhclN1YmplY3QubmV4dChudWxsKVxuICAgIH1cbiAgfVxuXG4gIGdldEF2YXRhcigpOiBPYnNlcnZhYmxlPEF2YXRhckluZm8+IHtcbiAgICByZXR1cm4gdGhpcy5hdmF0YXJTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVVzZXJGcm9tVXNlclByb2ZpbGUodXNlclByb2ZpbGU6IFVzZXJQcm9maWxlKSB7XG4gICAgdGhpcy51c2VyID0ge1xuICAgICAgcm9sZXM6IHVzZXJQcm9maWxlLnJvbGVzLFxuICAgICAgdXNlcklkOiB1c2VyUHJvZmlsZS5pZCxcbiAgICAgIHByaW5jaXBhbElkOiB1c2VyUHJvZmlsZS5pZCxcbiAgICAgIGNvbW1vbk5hbWU6IHVzZXJQcm9maWxlLnBlcnNvbi5kaXNwbGF5TmFtZSxcbiAgICAgIHVzZXJQZXJzb246IHsgLi4udXNlclByb2ZpbGUucGVyc29uIH0sXG4gICAgICBmdW5jdGlvbnM6IFtdLFxuICAgIH1cbiAgICBpZiAodGhpcy51c2VyUHJvZmlsZS5tZW1iZXJzaGlwcykge1xuICAgICAgdGhpcy51c2VyUHJvZmlsZS5tZW1iZXJzaGlwcy5mb3JFYWNoKG0gPT4ge1xuICAgICAgICBtLnJvbGVNZW1iZXJzaGlwcy5mb3JFYWNoKHIgPT4ge1xuICAgICAgICAgIHIucGVybWlzc2lvbnMuZm9yRWFjaChwID0+IHtcbiAgICAgICAgICAgIHRoaXMudXNlci5mdW5jdGlvbnMucHVzaChwLmtleSlcbiAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICB9XG4gIH1cbn1cbiJdfQ==