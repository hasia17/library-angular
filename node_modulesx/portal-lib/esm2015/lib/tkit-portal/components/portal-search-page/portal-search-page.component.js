import { Component, EventEmitter, Injector, Input, Output, Inject, Optional, SkipSelf } from '@angular/core';
import { MessageService } from 'primeng/api';
import { PortalPageComponent } from '../portal-page/portal-page.component';
import { SearchTemplateAPIService } from '../../../api/services/search-template-api.service';
import { AUTH_SERVICE } from '../../../api/injection-tokens';
import { PortalViewportComponent } from '../portal-viewport/portal-viewport.component';
import { PortalSearchPage } from '../../pages/PortalSearchPage';
const reISO = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;
const dateReviver = function (key, value) {
    if (typeof value === 'string') {
        const a = reISO.exec(value);
        if (a) {
            return new Date(value);
        }
    }
    return value;
};
const ɵ0 = dateReviver;
export class PortalSearchPageComponent extends PortalPageComponent {
    constructor(injectorChild, messageService, searchTemplateApi, auth, viewPort, searchPage) {
        super(injectorChild);
        this.messageService = messageService;
        this.searchTemplateApi = searchTemplateApi;
        this.auth = auth;
        this.viewPort = viewPort;
        this.searchPage = searchPage;
        this.searchCriteriaTemplatesEnabled = true;
        this.enableSearchToolbar = false;
        this.onSearch = new EventEmitter();
        this.newTemplateDefaultFlag = false;
    }
    ngOnInit() {
        super.ngOnInit();
        this.validatedInputs();
        if (this.pageName) {
            this.fetchSearchTemplates();
        }
    }
    onSearchTemplateSelection(event) {
        if (event.value) {
            this.activeSearchTemplateId = event.value;
            this.searchTemplateApi
                .getTemplateById(this.activeSearchTemplateId)
                .subscribe(template => {
                this.activeSearchTemplate = template;
                // TODO allow override
                this.searchPage.criteria = JSON.parse(template.criteriaAsJson, dateReviver);
            });
        }
        else {
            this.activeSearchTemplateId = null;
            this.activeSearchTemplate = null;
        }
    }
    fetchSearchTemplates() {
        this.searchTemplateApi
            .getSearchTemplatesLegacy(this.auth.currentUser().userId, this.viewPort.appName, this.pageName)
            .subscribe(templates => {
            this.searchTemplateOptions = [
                { value: null, label: 'Pick saved template' },
                ...templates.map(t => ({ label: t.name, value: t.id }))
            ];
            // if a default template exists preselect it
            const defaultTemplate = templates.find(t => t.defaultTemplate);
            if (defaultTemplate) {
                this.onSearchTemplateSelection({ value: defaultTemplate.id });
            }
        });
    }
    validatedInputs() {
        if (!this.searchPage) {
            console.error(`<tk-search-page> can only be used in a component that extends "PortalSearchPage". See README.MD chapter #Generic Search Page`);
        }
        if (!this.pageName) {
            console.warn(`You did not specify [pageName] attribute for search page component. Without it, some features will not work.`);
        }
    }
    triggerSearch() {
        console.log(`Click search`);
        this.onSearch.emit(1);
    }
    triggerCriteriaTemplateUpdate() {
        console.log('update tempalte');
        this.activeSearchTemplate.criteriaAsJson = JSON.stringify(this.searchPage.criteria);
        this.searchTemplateApi
            .updateTemplate(this.activeSearchTemplateId, this.activeSearchTemplate)
            .subscribe(savedTemplate => {
            this.activeSearchTemplate = savedTemplate;
            this.messageService.add({
                severity: 'success',
                summary: 'Search template updated'
            });
        });
    }
    triggerCriteriaTemplateSave(event, op) {
        this.searchTemplateApi
            .createNewTemplate({
            application: this.viewPort.appName,
            page: this.pageName,
            user: this.auth.currentUser().userId,
            name: this.newTemplateName,
            defaultTemplate: this.newTemplateDefaultFlag,
            criteriaAsJson: JSON.stringify(this.searchPage.criteria)
        })
            .subscribe(savedTemplate => {
            this.activeSearchTemplate = savedTemplate;
            this.searchTemplateOptions.push({
                label: savedTemplate.name,
                value: savedTemplate.id
            });
            this.activeSearchTemplateId = savedTemplate.id;
            op.hide();
            this.newTemplateDefaultFlag = false;
            this.newTemplateName = undefined;
            this.messageService.add({
                severity: 'success',
                summary: 'Search template saved'
            });
        });
    }
    triggerCriteriaTemplateDelete() {
        this.searchTemplateApi
            .deleteTemplate(this.activeSearchTemplateId)
            .subscribe(ok => {
            this.messageService.add({
                severity: 'info',
                summary: 'Search template deleted'
            });
            this.searchTemplateOptions.splice(this.searchTemplateOptions.findIndex(i => i.value == this.activeSearchTemplateId), 1);
            this.activeSearchTemplateId = undefined;
            this.activeSearchTemplate = undefined;
        });
    }
}
PortalSearchPageComponent.decorators = [
    { type: Component, args: [{
                selector: 'tk-portal-search-page',
                template: "<tk-portal-page\n  header=\"{{ header }}\"\n  [leftToolbar]=\"pageToolbarLeft\"\n  [rightToolbar]=\"pageToolbarRight\"\n>\n  <div id=\"criteria-panel\" tkCollapsible>\n    <ng-content select=\"[criteria]\"></ng-content>\n  </div>\n\n  <div id=\"search-results\">\n    <ng-content select=\"[results]\"></ng-content>\n  </div>\n</tk-portal-page>\n\n<ng-template #pageToolbarLeft>\n  <tk-toolbar-item\n    *ngIf=\"enableSearchToolbar\"\n    title=\"Suchen\"\n    icon=\"search\"\n    (click)=\"triggerSearch()\"\n  ></tk-toolbar-item>\n  <ng-container *ngTemplateOutlet=\"leftToolbar\"></ng-container>\n</ng-template>\n\n<ng-template #pageToolbarRight>\n  <ng-container *ngTemplateOutlet=\"rightToolbar\"></ng-container>\n  <p-overlayPanel\n    #op\n    [dismissable]=\"true\"\n    [showCloseIcon]=\"true\"\n    appendTo=\"body\"\n  >\n    <div class=\"p-fluid\" [ngStyle]=\"{ width: '400px' }\">\n      <h5>Save a new search template</h5>\n      <div class=\"p-field p-grid\">\n        <label class=\"p-col-12 p-md-4\" for=\"templateName\">Template Name</label>\n        <div class=\"p-col-12 p-md-8\">\n          <input\n            id=\"templateName\"\n            pInputText\n            type=\"text\"\n            [(ngModel)]=\"newTemplateName\"\n          />\n        </div>\n      </div>\n      <div class=\"p-field p-grid\">\n        <label class=\"p-col-12 p-md-4\" for=\"defaultFlag\">Set as default?</label>\n        <!--      </div>-->\n        <div class=\"p-col-12 p-md-8\">\n          <p-inputSwitch\n            id=\"defaultFlag\"\n            [(ngModel)]=\"newTemplateDefaultFlag\"\n          ></p-inputSwitch>\n        </div>\n      </div>\n\n      <div class=\"p-grid\">\n        <div class=\"p-col-6\">\n          <button\n            type=\"button\"\n            pButton\n            label=\"Cancel\"\n            (click)=\"op.hide()\"\n            class=\"p-button-secondary p-col-12\"\n          ></button>\n        </div>\n        <div class=\"p-col-6\">\n          <button\n            type=\"button\"\n            pButton\n            label=\"Save\"\n            class=\"p-col-12\"\n            (click)=\"triggerCriteriaTemplateSave($event, op)\"\n          ></button>\n        </div>\n      </div>\n    </div>\n  </p-overlayPanel>\n  <tk-toolbar-item\n    *ngIf=\"searchCriteriaTemplatesEnabled\"\n    title=\"Neue Suchvorlage Erstellen\"\n    icon=\"plus\"\n    (click)=\"op.show($event)\"\n  ></tk-toolbar-item>\n  <tk-toolbar-item\n    *ngIf=\"activeSearchTemplate\"\n    title=\"Suchvorlage Speichern\"\n    icon=\"save\"\n    (click)=\"triggerCriteriaTemplateUpdate()\"\n  ></tk-toolbar-item>\n  <tk-toolbar-item\n    *ngIf=\"activeSearchTemplate\"\n    title=\"Suchvorlage Loeschen\"\n    icon=\"trash\"\n    (click)=\"triggerCriteriaTemplateDelete()\"\n  ></tk-toolbar-item>\n  <div class=\"search-template-box\" *ngIf=\"searchTemplateOptions\">\n    <p-dropdown\n      [style]=\"{ width: '150px' }\"\n      appendTo=\"body\"\n      [ngModel]=\"activeSearchTemplateId\"\n      [options]=\"searchTemplateOptions\"\n      [filter]=\"true\"\n      (onChange)=\"onSearchTemplateSelection($event)\"\n    ></p-dropdown>\n  </div>\n\n  <tk-toolbar-item\n    *ngIf=\"collapsible2\"\n    title=\"Ausblenden\"\n    class=\"collapse-toggle\"\n    icon=\"angle-up\"\n    (click)=\"collapsed ? expand() : collapse()\"\n  ></tk-toolbar-item>\n</ng-template>\n",
                styles: [".search-template-box{display:inline-block;padding-top:.2em}.search-template-box ::ng-deep .p-dropdown-label{padding:.5em}"]
            },] }
];
PortalSearchPageComponent.ctorParameters = () => [
    { type: Injector },
    { type: MessageService },
    { type: SearchTemplateAPIService },
    { type: undefined, decorators: [{ type: Inject, args: [AUTH_SERVICE,] }] },
    { type: PortalViewportComponent },
    { type: PortalSearchPage, decorators: [{ type: SkipSelf }, { type: Optional }] }
];
PortalSearchPageComponent.propDecorators = {
    searchCriteriaTemplatesEnabled: [{ type: Input }],
    enableSearchToolbar: [{ type: Input }],
    onSearch: [{ type: Output }],
    pageName: [{ type: Input }]
};
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGFsLXNlYXJjaC1wYWdlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3BvcnRhbC1saWIvc3JjL2xpYi90a2l0LXBvcnRhbC9jb21wb25lbnRzL3BvcnRhbC1zZWFyY2gtcGFnZS9wb3J0YWwtc2VhcmNoLXBhZ2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFFBQVEsRUFDUixLQUFLLEVBQ0wsTUFBTSxFQUNOLE1BQU0sRUFDTixRQUFRLEVBQ1IsUUFBUSxFQUNULE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFN0MsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDM0UsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDN0YsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRTdELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRWhFLE1BQU0sS0FBSyxHQUFHLGtGQUFrRixDQUFDO0FBQ2pHLE1BQU0sV0FBVyxHQUFHLFVBQVMsR0FBRyxFQUFFLEtBQUs7SUFDckMsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7UUFDN0IsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsRUFBRTtZQUNMLE9BQU8sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEI7S0FDRjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyxDQUFDOztBQU1GLE1BQU0sT0FBTyx5QkFBMEIs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QUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7O1lBN0pGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsdUJBQXVCO2dCQUNqQyw0ekdBQWtEOzthQUVuRDs7O1lBL0JDLFFBQVE7WUFRRCxjQUFjO1lBR2Qsd0JBQXdCOzRDQXdDNUIsTUFBTSxTQUFDLFlBQVk7WUFyQ2YsdUJBQXVCO1lBQ3ZCLGdCQUFnQix1QkFzQ3BCLFFBQVEsWUFBSSxRQUFROzs7NkNBcEJ0QixLQUFLO2tDQUNMLEtBQUs7dUJBQ0wsTUFBTTt1QkFJTixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdG9yLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBJbmplY3QsXG4gIE9wdGlvbmFsLFxuICBTa2lwU2VsZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFNlbGVjdEl0ZW0gfSBmcm9tICdwcmltZW5nL2FwaSc7XG5pbXBvcnQgeyBNZXNzYWdlU2VydmljZSB9IGZyb20gJ3ByaW1lbmcvYXBpJztcbmltcG9ydCB7IFNlYXJjaFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vYXBpL21vZGVsL3NlYXJjaC10ZW1wbGF0ZS5tb2RlbCc7XG5pbXBvcnQgeyBQb3J0YWxQYWdlQ29tcG9uZW50IH0gZnJvbSAnLi4vcG9ydGFsLXBhZ2UvcG9ydGFsLXBhZ2UuY29tcG9uZW50JztcbmltcG9ydCB7IFNlYXJjaFRlbXBsYXRlQVBJU2VydmljZSB9IGZyb20gJy4uLy4uLy4uL2FwaS9zZXJ2aWNlcy9zZWFyY2gtdGVtcGxhdGUtYXBpLnNlcnZpY2UnO1xuaW1wb3J0IHsgQVVUSF9TRVJWSUNFIH0gZnJvbSAnLi4vLi4vLi4vYXBpL2luamVjdGlvbi10b2tlbnMnO1xuaW1wb3J0IHsgSUF1dGhTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vYXBpL2lhdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9ydGFsVmlld3BvcnRDb21wb25lbnQgfSBmcm9tICcuLi9wb3J0YWwtdmlld3BvcnQvcG9ydGFsLXZpZXdwb3J0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb3J0YWxTZWFyY2hQYWdlIH0gZnJvbSAnLi4vLi4vcGFnZXMvUG9ydGFsU2VhcmNoUGFnZSc7XG5cbmNvbnN0IHJlSVNPID0gL14oXFxkezR9KS0oXFxkezJ9KS0oXFxkezJ9KVQoXFxkezJ9KTooXFxkezJ9KTooXFxkezJ9KD86XFwuXFxkKikpKD86WnwoXFwrfC0pKFtcXGR8Ol0qKSk/JC87XG5jb25zdCBkYXRlUmV2aXZlciA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHtcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICBjb25zdCBhID0gcmVJU08uZXhlYyh2YWx1ZSk7XG4gICAgaWYgKGEpIHtcbiAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB2YWx1ZTtcbn07XG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0ay1wb3J0YWwtc2VhcmNoLXBhZ2UnLFxuICB0ZW1wbGF0ZVVybDogJy4vcG9ydGFsLXNlYXJjaC1wYWdlLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vcG9ydGFsLXNlYXJjaC1wYWdlLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgUG9ydGFsU2VhcmNoUGFnZUNvbXBvbmVudCBleHRlbmRzIFBvcnRhbFBhZ2VDb21wb25lbnQge1xuICBASW5wdXQoKSBzZWFyY2hDcml0ZXJpYVRlbXBsYXRlc0VuYWJsZWQgPSB0cnVlO1xuICBASW5wdXQoKSBlbmFibGVTZWFyY2hUb29sYmFyID0gZmFsc2U7XG4gIEBPdXRwdXQoKSBvblNlYXJjaDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIGFjdGl2ZVNlYXJjaFRlbXBsYXRlOiBTZWFyY2hUZW1wbGF0ZTtcbiAgYWN0aXZlU2VhcmNoVGVtcGxhdGVJZDogc3RyaW5nO1xuXG4gIEBJbnB1dCgpXG4gIHByaXZhdGUgcGFnZU5hbWU6IHN0cmluZztcblxuICBzZWFyY2hUZW1wbGF0ZU9wdGlvbnM6IFNlbGVjdEl0ZW1bXTtcblxuICBuZXdUZW1wbGF0ZU5hbWU6IHN0cmluZztcbiAgbmV3VGVtcGxhdGVEZWZhdWx0RmxhZyA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGluamVjdG9yQ2hpbGQ6IEluamVjdG9yLFxuICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IE1lc3NhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgc2VhcmNoVGVtcGxhdGVBcGk6IFNlYXJjaFRlbXBsYXRlQVBJU2VydmljZSxcbiAgICBASW5qZWN0KEFVVEhfU0VSVklDRSkgcHJpdmF0ZSBhdXRoOiBJQXV0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB2aWV3UG9ydDogUG9ydGFsVmlld3BvcnRDb21wb25lbnQsXG4gICAgQFNraXBTZWxmKCkgQE9wdGlvbmFsKCkgcHVibGljIHNlYXJjaFBhZ2U6IFBvcnRhbFNlYXJjaFBhZ2U8YW55LCBhbnk+XG4gICkge1xuICAgIHN1cGVyKGluamVjdG9yQ2hpbGQpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgc3VwZXIubmdPbkluaXQoKTtcbiAgICB0aGlzLnZhbGlkYXRlZElucHV0cygpO1xuICAgIGlmICh0aGlzLnBhZ2VOYW1lKSB7XG4gICAgICB0aGlzLmZldGNoU2VhcmNoVGVtcGxhdGVzKCk7XG4gICAgfVxuICB9XG5cbiAgb25TZWFyY2hUZW1wbGF0ZVNlbGVjdGlvbihldmVudDogYW55KSB7XG4gICAgaWYgKGV2ZW50LnZhbHVlKSB7XG4gICAgICB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlSWQgPSBldmVudC52YWx1ZTtcbiAgICAgIHRoaXMuc2VhcmNoVGVtcGxhdGVBcGlcbiAgICAgICAgLmdldFRlbXBsYXRlQnlJZCh0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlSWQpXG4gICAgICAgIC5zdWJzY3JpYmUodGVtcGxhdGUgPT4ge1xuICAgICAgICAgIHRoaXMuYWN0aXZlU2VhcmNoVGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICAgICAgICAvLyBUT0RPIGFsbG93IG92ZXJyaWRlXG4gICAgICAgICAgdGhpcy5zZWFyY2hQYWdlLmNyaXRlcmlhID0gSlNPTi5wYXJzZShcbiAgICAgICAgICAgIHRlbXBsYXRlLmNyaXRlcmlhQXNKc29uLFxuICAgICAgICAgICAgZGF0ZVJldml2ZXJcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hY3RpdmVTZWFyY2hUZW1wbGF0ZUlkID0gbnVsbDtcbiAgICAgIHRoaXMuYWN0aXZlU2VhcmNoVGVtcGxhdGUgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmV0Y2hTZWFyY2hUZW1wbGF0ZXMoKSB7XG4gICAgdGhpcy5zZWFyY2hUZW1wbGF0ZUFwaVxuICAgICAgLmdldFNlYXJjaFRlbXBsYXRlc0xlZ2FjeShcbiAgICAgICAgdGhpcy5hdXRoLmN1cnJlbnRVc2VyKCkudXNlcklkLFxuICAgICAgICB0aGlzLnZpZXdQb3J0LmFwcE5hbWUsXG4gICAgICAgIHRoaXMucGFnZU5hbWVcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUodGVtcGxhdGVzID0+IHtcbiAgICAgICAgdGhpcy5zZWFyY2hUZW1wbGF0ZU9wdGlvbnMgPSBbXG4gICAgICAgICAgeyB2YWx1ZTogbnVsbCwgbGFiZWw6ICdQaWNrIHNhdmVkIHRlbXBsYXRlJyB9LFxuICAgICAgICAgIC4uLnRlbXBsYXRlcy5tYXAodCA9PiAoeyBsYWJlbDogdC5uYW1lLCB2YWx1ZTogdC5pZCB9KSlcbiAgICAgICAgXTtcblxuICAgICAgICAvLyBpZiBhIGRlZmF1bHQgdGVtcGxhdGUgZXhpc3RzIHByZXNlbGVjdCBpdFxuICAgICAgICBjb25zdCBkZWZhdWx0VGVtcGxhdGUgPSB0ZW1wbGF0ZXMuZmluZCh0ID0+IHQuZGVmYXVsdFRlbXBsYXRlKTtcbiAgICAgICAgaWYgKGRlZmF1bHRUZW1wbGF0ZSkge1xuICAgICAgICAgIHRoaXMub25TZWFyY2hUZW1wbGF0ZVNlbGVjdGlvbih7IHZhbHVlOiBkZWZhdWx0VGVtcGxhdGUuaWQgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgdmFsaWRhdGVkSW5wdXRzKCkge1xuICAgIGlmICghdGhpcy5zZWFyY2hQYWdlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFxuICAgICAgICBgPHRrLXNlYXJjaC1wYWdlPiBjYW4gb25seSBiZSB1c2VkIGluIGEgY29tcG9uZW50IHRoYXQgZXh0ZW5kcyBcIlBvcnRhbFNlYXJjaFBhZ2VcIi4gU2VlIFJFQURNRS5NRCBjaGFwdGVyICNHZW5lcmljIFNlYXJjaCBQYWdlYFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnBhZ2VOYW1lKSB7XG4gICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgIGBZb3UgZGlkIG5vdCBzcGVjaWZ5IFtwYWdlTmFtZV0gYXR0cmlidXRlIGZvciBzZWFyY2ggcGFnZSBjb21wb25lbnQuIFdpdGhvdXQgaXQsIHNvbWUgZmVhdHVyZXMgd2lsbCBub3Qgd29yay5gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHRyaWdnZXJTZWFyY2goKSB7XG4gICAgY29uc29sZS5sb2coYENsaWNrIHNlYXJjaGApO1xuICAgIHRoaXMub25TZWFyY2guZW1pdCgxKTtcbiAgfVxuXG4gIHRyaWdnZXJDcml0ZXJpYVRlbXBsYXRlVXBkYXRlKCkge1xuICAgIGNvbnNvbGUubG9nKCd1cGRhdGUgdGVtcGFsdGUnKTtcbiAgICB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlLmNyaXRlcmlhQXNKc29uID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICB0aGlzLnNlYXJjaFBhZ2UuY3JpdGVyaWFcbiAgICApO1xuICAgIHRoaXMuc2VhcmNoVGVtcGxhdGVBcGlcbiAgICAgIC51cGRhdGVUZW1wbGF0ZSh0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlSWQsIHRoaXMuYWN0aXZlU2VhcmNoVGVtcGxhdGUpXG4gICAgICAuc3Vic2NyaWJlKHNhdmVkVGVtcGxhdGUgPT4ge1xuICAgICAgICB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlID0gc2F2ZWRUZW1wbGF0ZTtcbiAgICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS5hZGQoe1xuICAgICAgICAgIHNldmVyaXR5OiAnc3VjY2VzcycsXG4gICAgICAgICAgc3VtbWFyeTogJ1NlYXJjaCB0ZW1wbGF0ZSB1cGRhdGVkJ1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgdHJpZ2dlckNyaXRlcmlhVGVtcGxhdGVTYXZlKGV2ZW50OiBFdmVudCwgb3A6IGFueSkge1xuICAgIHRoaXMuc2VhcmNoVGVtcGxhdGVBcGlcbiAgICAgIC5jcmVhdGVOZXdUZW1wbGF0ZSh7XG4gICAgICAgIGFwcGxpY2F0aW9uOiB0aGlzLnZpZXdQb3J0LmFwcE5hbWUsXG4gICAgICAgIHBhZ2U6IHRoaXMucGFnZU5hbWUsXG4gICAgICAgIHVzZXI6IHRoaXMuYXV0aC5jdXJyZW50VXNlcigpLnVzZXJJZCxcbiAgICAgICAgbmFtZTogdGhpcy5uZXdUZW1wbGF0ZU5hbWUsXG4gICAgICAgIGRlZmF1bHRUZW1wbGF0ZTogdGhpcy5uZXdUZW1wbGF0ZURlZmF1bHRGbGFnLFxuICAgICAgICBjcml0ZXJpYUFzSnNvbjogSlNPTi5zdHJpbmdpZnkodGhpcy5zZWFyY2hQYWdlLmNyaXRlcmlhKVxuICAgICAgfSlcbiAgICAgIC5zdWJzY3JpYmUoc2F2ZWRUZW1wbGF0ZSA9PiB7XG4gICAgICAgIHRoaXMuYWN0aXZlU2VhcmNoVGVtcGxhdGUgPSBzYXZlZFRlbXBsYXRlO1xuICAgICAgICB0aGlzLnNlYXJjaFRlbXBsYXRlT3B0aW9ucy5wdXNoKHtcbiAgICAgICAgICBsYWJlbDogc2F2ZWRUZW1wbGF0ZS5uYW1lLFxuICAgICAgICAgIHZhbHVlOiBzYXZlZFRlbXBsYXRlLmlkXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlSWQgPSBzYXZlZFRlbXBsYXRlLmlkO1xuICAgICAgICBvcC5oaWRlKCk7XG4gICAgICAgIHRoaXMubmV3VGVtcGxhdGVEZWZhdWx0RmxhZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLm5ld1RlbXBsYXRlTmFtZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5tZXNzYWdlU2VydmljZS5hZGQoe1xuICAgICAgICAgIHNldmVyaXR5OiAnc3VjY2VzcycsXG4gICAgICAgICAgc3VtbWFyeTogJ1NlYXJjaCB0ZW1wbGF0ZSBzYXZlZCdcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuICB0cmlnZ2VyQ3JpdGVyaWFUZW1wbGF0ZURlbGV0ZSgpIHtcbiAgICB0aGlzLnNlYXJjaFRlbXBsYXRlQXBpXG4gICAgICAuZGVsZXRlVGVtcGxhdGUodGhpcy5hY3RpdmVTZWFyY2hUZW1wbGF0ZUlkKVxuICAgICAgLnN1YnNjcmliZShvayA9PiB7XG4gICAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2UuYWRkKHtcbiAgICAgICAgICBzZXZlcml0eTogJ2luZm8nLFxuICAgICAgICAgIHN1bW1hcnk6ICdTZWFyY2ggdGVtcGxhdGUgZGVsZXRlZCdcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5zZWFyY2hUZW1wbGF0ZU9wdGlvbnMuc3BsaWNlKFxuICAgICAgICAgIHRoaXMuc2VhcmNoVGVtcGxhdGVPcHRpb25zLmZpbmRJbmRleChcbiAgICAgICAgICAgIGkgPT4gaS52YWx1ZSA9PSB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlSWRcbiAgICAgICAgICApLFxuICAgICAgICAgIDFcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5hY3RpdmVTZWFyY2hUZW1wbGF0ZUlkID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLmFjdGl2ZVNlYXJjaFRlbXBsYXRlID0gdW5kZWZpbmVkO1xuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==